---
title: "Statistical Case Studies - Project 1 part 2"
author: "Georgia Ettles, Mayez Haris and Niharika Peddinenikalva"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(1234)
library(ggplot2)
library(tidyverse)
library(gridExtra)
library(countrycode)
library(visdat)
```

# Load data

```{r easyshare}
load("easySHARE_rel8_0_0.rda")
data <- easySHARE_rel8_0_0

```



```{r}
cogvars <- c("recall_1", "recall_2", "orienti", "numeracy_1", "numeracy_2")
cog = data[cogvars]

numeracy = rep(NA,dim(cog)[1])
numeracy[cog$numeracy_1 >= 0 & cog$numeracy_2 >= 0] = (cog$numeracy_1[cog$numeracy_1 >= 0 & cog$numeracy_2 >= 0] + cog$numeracy_2[cog$numeracy_1 >= 0 & cog$numeracy_2 >= 0] )/2
numeracy[cog$numeracy_1 >= 0 & cog$numeracy_2 < 0] = cog$numeracy_1[cog$numeracy_1 >= 0 & cog$numeracy_2 < 0]
numeracy[cog$numeracy_1 < 0 & cog$numeracy_2 >= 0] = cog$numeracy_2[cog$numeracy_1 < 0 & cog$numeracy_2 >= 0]
cog$numeracy = numeracy

cogscore = rep(NA,dim(cog)[1])
ind = cog$recall_1 >= 0 & cog$recall_2 >= 0 & cog$orienti >= 0 & !is.na(numeracy)
cogscore[ind] = cog$recall_1[ind] + cog$recall_2[ind] +  cog$orienti[ind] + cog$numeracy[ind]
cog$cogscore = cogscore

data$cogscore<-cog$cogscore

```


```{r}
# Set missing values to NA       
data[data < 0] <- NA

# Replace country codes with country names
data$country_mod <- countrycode(factor(data$country_mod),
  origin = "iso3n",
  destination = "country.name"
)

length(unique(data$mergeid))
table(data$wave,data$int_year)
table(data$country_mod, data$wave)
```

```{r vars}
variable_list <- c("female", "age", "dn004_mod", "iv009_mod", "isced1997_r",
                   "mar_stat", "hhsize", "ch001_", "sp002_mod", "chronic_mod", 
                   "casp", "eurod", "hc002_mod", "hc012_", 
                   "hc029_" , "iadlza", "adla" , "maxgrip", "bmi2", 
                   "ever_smoked", "br015_", "ep005_", "co007_")

binary_list <- c("female",  "dn004_mod", "sp002_mod",  
                 "hc012_", "hc029_" , "ever_smoked")

categorical_list <- c("iv009_mod", "isced1997_r", "mar_stat", "hhsize", "ch001_", "chronic_mod", 
                     "casp", "eurod", "hc002_mod", "iadlza", "adla" , "maxgrip", 
                     "bmi2", "br015_", "ep005_", "co007_")

nonfactor_list <- c("age")

```


```{r factoring}
# Factoring binary variables as dummy variables
for (column in binary_list) {
  if (column != "hc029_") {
    data[, column] <- ifelse(data[, column] == "1", 1, 0)
  } else {
    data$hc029_ <- ifelse(data[, column] == "5", 0, 1)
  }
  data[, column] <- factor(data[, column], levels = c(0, 1), labels = c("No", "Yes"))
}


# Factor non-binary variables
for (column in categorical_list) {
  data[, column] <- factor(data[, column])
}

# Simplifying levels for specific variables
levels(data$isced1997_r) <- list(
  "Secondary and Below" = as.character(0:3),
  "Post Secondary" = as.character(4:6),
  "Other" = as.character(95:96)
)

levels(data$eurod) <- list(
  "Not Depressed" = as.character(0:3),
  "Somewhat Depressed" = as.character(4:6),
  "Relatively Depressed" = as.character(7:9),
  "Very Depressed" = as.character(10:12)
)


levels(data$iv009_mod) <- list(
  "City_sub" = as.character(1:2),
  "Town_rural" = as.character(3:5)
)

levels(data$sphus) <- list(
  "Good" = as.character(1:3),
  "Not Good" = as.character(4:5)
)

levels(data$ch001_) <- list(
  "0" = as.character(0),
  "1-2" = as.character(1:2),
  "More than 2" = as.character(3:19)
)

levels(data$chronic_mod) <- list(
  "0" = as.character(0),
  "1-3" = as.character(1:3),
  "4-6" = as.character(4:6),
  "7-10" = as.character(7:10)
)

levels(data$adla) <- list(
  "High Mobility" = as.character(0:2),
  "Low Mobility" = as.character(3:5)
)

levels(data$iadlza) <- list(
  "Low Difficulty" = as.character(0:2),
  "High Difficulty" = as.character(3:5)
)

levels(data$br015_) <- list(
  "Often" = as.character(1:2),
  "Rarely" = as.character(3:4)
)

levels(data$co007_) <- list(
  "With Difficulty" = as.character(1:2),
  "Relatively easily" = as.character(3:4)
)

levels(data$hhsize) <- list(
  "Up to 4" = as.character(1:4),
  "More than 4" = as.character(c(4:15))
)

levels(data$maxgrip) <- list(
  "Low" = as.character(1:29),
  "High" = as.character(30:99)
)

levels(data$casp) <- list(
  "12-24" = as.character(12:24),
  "24-36" = as.character(24:36),
  "36-48" = as.character(36:48)
)

levels(data$hc002_mod) <- list(
  "0-10" = as.character(0:10),
  "More than 10" = as.character(10:98)
)

levels(data$ep005_) <- list(
  "Retired" = as.character(1),
  "Employed" = as.character(2),
  "Unemployed/at home" = as.character(3:5),
  "Other" = as.character(97)
)

levels(data$bmi2) <- list(
  "_Underweight" = as.character(1),
  "_Normal" = as.character(2),
  "_Overweight" = as.character(3),
  "_Obese" = as.character(4)
)

levels(data$mar_stat) <- list(
  "Married" = as.character(1),
  "Unmarried" = as.character(c(0,4)),
  "Widowed" = as.character(6),
  "Divorced/Separated" = as.character(c(2,3,5))
)
```

```{r}
working_data <- data %>% 
  filter(wave == 4, country_mod == "Estonia") %>% 
  select(all_of(variable_list), "cogscore")

summary(working_data$cogscore)
vis_miss(working_data)

# Removing 200 observations to get training data
del_ind <- sample.int(nrow(working_data), 200)
training_data <- working_data[-del_ind, ]
del_data <- working_data[del_ind, ]
```

```{r}
# Display summary statistics
summary(training_data)

# par(mfrow = c(13, 2))
# Box plots to show how BMI varies across different variables
boxplot(cogscore ~ age, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ female, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ dn004_mod, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ iv009_mod, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ isced1997_r, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ mar_stat, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ hhsize, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ ch001_, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ sp002_mod, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ chronic_mod, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ casp, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ eurod, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ hc002_mod, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ hc012_, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ hc029_, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ iadlza, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ adla, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ maxgrip, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ bmi2, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ ever_smoked, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ br015_, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ ep005_, data = working_data, ylab = "Composite Cognitive score")
boxplot(cogscore ~ co007_, data = working_data, ylab = "Composite Cognitive score")
```





```{r}
# Define model formula that applies to both will be applied to both males and females
mod <- cogscore ~ female + age + dn004_mod + iv009_mod + isced1997_r +
  hhsize + sp002_mod + chronic_mod + casp + eurod + hc002_mod + hc012_ + hc029_ +
  iadlza + adla + maxgrip + br015_ + ep005_ + co007_ + female:age + 
  iv009_mod:sp002_mod  + hhsize:co007_ + age:hc002_mod + hc029_:iadlza


# Define model
fit <- lm(mod, data = na.omit(training_data))

# Display model assumptions through residuals
par(mfrow = c(2, 2))
plot(fit)

# Add trace=F to not print each step of the step function
better_fit <- step(fit, trace = F)
summary(better_fit)
plot(better_fit)
confint(better_fit)
```



```{r set-up-scores}
compute_se <- function(model, test_data) {
  predicted_vals <- predict(model, newdata = test_data)
  se_scores <- (predicted_vals - test_data$cogscore)**2
  rmse_score <- sqrt(mean(se_scores))
  rmse_score
}

# Test data same as training data
test1 <- na.omit(training_data)

# Test data is removed data
test2 <- na.omit(del_data)

# Test data is same wave (4) different country (Austria)
test3 <- data %>% 
  filter(wave == 4, country_mod == "Austria") %>% 
  select(all_of(variable_list), "cogscore")

# Test data is same country (Estonia) different wave (6)
test4 <- data %>% 
  filter(wave == 6, country_mod == "Estonia") %>% 
  select(all_of(variable_list), "cogscore")
```

```{r calc-scores}
compute_se(model = fit, test_data = test1)
compute_se(model = fit, test_data = test2)
compute_se(model = fit, test_data = na.omit(test3))
compute_se(model = fit, test_data = na.omit(test4))

```

